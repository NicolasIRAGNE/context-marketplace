{% extends "base.html" %}

{% block title %}Create Context - Context Marketplace{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">Create New Context</h1>
        <p class="text-gray-600">Set up a new LLM-ready code context from your GitHub repository</p>
    </div>
    
    <div class="bg-white card-shadow p-8">
        <div id="loading-repos" class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
            <p class="mt-2 text-gray-600">Loading your GitHub repositories...</p>
        </div>
        
        <form id="create-context-form" class="hidden">
            <div class="mb-6">
                <label for="repository-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Search for Repository *
                </label>
                <div class="relative">
                    <input
                        type="text"
                        id="repository-input"
                        name="repository"
                        required
                        autocomplete="off"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Type to search your repositories or enter GitHub URL..."
                    >
                    <div id="repository-dropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
                <p class="mt-1 text-xs text-gray-500">
                    Search your accessible repositories or enter any GitHub URL (owner/repo or full URL)
                </p>
            </div>
            
            <div id="repo-preview" class="mb-6 hidden">
                <div class="bg-gray-50 border rounded-lg p-4">
                    <div class="flex items-center gap-3">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                        <div>
                            <h3 id="repo-name" class="font-bold"></h3>
                            <p id="repo-description" class="text-sm text-gray-600"></p>
                            <div id="repo-languages" class="flex gap-2 mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <div class="flex items-center">
                    <input
                        type="checkbox"
                        id="is_public"
                        name="is_public"
                        checked
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    >
                    <label for="is_public" class="ml-2 block text-sm text-gray-700">
                        Make this context public (others can view and use it)
                    </label>
                </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-6">
                <h3 class="text-sm font-medium text-blue-900 mb-2">What happens next?</h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>• Default context files will be created (stack.md, business.md, people.md, guidelines.md)</li>
                    <li>• If you provided a GitHub repo, we'll analyze it to pre-fill content</li>
                    <li>• You can edit, add, or remove any files after creation</li>
                    <li>• Contributors will be listed for you to select which ones to include</li>
                </ul>
            </div>
            
            <div class="flex gap-4">
                <button
                    type="submit"
                    class="btn-github flex-1"
                    id="submit-btn"
                >
                    Create Context
                </button>
                <a
                    href="/contexts"
                    class="flex-1 text-center bg-gray-200 text-gray-800 px-6 py-3 font-bold border-[3px] border-gray-900 shadow-[4px_4px_0_0_rgba(0,0,0,1)] hover:shadow-[2px_2px_0_0_rgba(0,0,0,1)] hover:translate-x-[2px] hover:translate-y-[2px] transition-all"
                >
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
let repositories = [];
let selectedRepo = null;
let filteredRepos = [];

// Load user's repositories on page load
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/user/repositories');
        if (response.ok) {
            repositories = await response.json();
            console.log(`Loaded ${repositories.length} repositories`);
            setupSearch();
        } else {
            showError('Failed to load repositories. Please try again.');
        }
    } catch (error) {
        console.error('Error loading repositories:', error);
        showError('Error loading repositories. Please check your connection.');
    }
});

function setupSearch() {
    const loadingDiv = document.getElementById('loading-repos');
    const form = document.getElementById('create-context-form');
    const input = document.getElementById('repository-input');
    const dropdown = document.getElementById('repository-dropdown');
    
    loadingDiv.classList.add('hidden');
    form.classList.remove('hidden');
    
    // Setup search functionality
    let searchTimeout;
    input.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = e.target.value.trim();
            if (query.length >= 1) {
                performSearch(query);
            } else {
                dropdown.classList.add('hidden');
                hideRepositoryPreview();
            }
        }, 150); // Debounce search
    });
    
    // Handle input focus
    input.addEventListener('focus', () => {
        if (input.value.trim().length >= 1) {
            performSearch(input.value.trim());
        }
    });
    
    // Handle clicking outside
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
    
    // Handle keyboard navigation
    input.addEventListener('keydown', (e) => {
        const items = dropdown.querySelectorAll('.dropdown-item');
        let currentIndex = Array.from(items).findIndex(item => item.classList.contains('highlighted'));
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (currentIndex < items.length - 1) {
                    if (currentIndex >= 0) items[currentIndex].classList.remove('highlighted');
                    items[currentIndex + 1].classList.add('highlighted');
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                if (currentIndex > 0) {
                    items[currentIndex].classList.remove('highlighted');
                    items[currentIndex - 1].classList.add('highlighted');
                }
                break;
            case 'Enter':
                e.preventDefault();
                if (currentIndex >= 0) {
                    items[currentIndex].click();
                } else if (items.length === 1) {
                    items[0].click();
                }
                break;
            case 'Escape':
                dropdown.classList.add('hidden');
                break;
        }
    });
}

function performSearch(query) {
    const dropdown = document.getElementById('repository-dropdown');
    
    // Check if it looks like a GitHub URL or owner/repo format
    const isUrl = query.includes('github.com') || query.match(/^[\w\-\.]+\/[\w\-\.]+$/);
    
    if (isUrl) {
        // Handle arbitrary repository input
        handleArbitraryRepo(query);
        return;
    }
    
    // Fuzzy search through repositories
    filteredRepos = fuzzySearch(repositories, query);
    
    if (filteredRepos.length === 0) {
        dropdown.innerHTML = `
            <div class="p-3 text-gray-500 text-center">
                No repositories found. Try entering owner/repo or GitHub URL.
            </div>
        `;
    } else {
        dropdown.innerHTML = filteredRepos.map(repo => `
            <div class="dropdown-item p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0"
                 data-repo="${JSON.stringify(repo).replace(/"/g, '&quot;')}">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <div class="font-medium">${highlightMatch(repo.full_name, query)}</div>
                            ${repo.owner_type === 'Organization' ? 
                                '<span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded">ORG</span>' : 
                                '<span class="bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded">USER</span>'
                            }
                            ${repo.fork ? '<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded">FORK</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${repo.description || 'No description'}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${repo.language ? `${repo.language} • ` : ''}
                            ${repo.private ? 'Private' : 'Public'} • 
                            ⭐ ${repo.stargazers_count || 0}
                            ${repo.permissions && repo.permissions.admin ? ' • Admin' : 
                              repo.permissions && repo.permissions.push ? ' • Write' : ' • Read'}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add click handlers
        dropdown.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
                const repo = JSON.parse(item.dataset.repo);
                selectRepository(repo);
            });
        });
    }
    
    dropdown.classList.remove('hidden');
}

function fuzzySearch(repos, query) {
    const searchTerms = query.toLowerCase().split(' ').filter(term => term.length > 0);
    
    return repos
        .map(repo => ({
            ...repo,
            score: calculateFuzzyScore(repo, searchTerms)
        }))
        .filter(repo => repo.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 20); // Limit results
}

function calculateFuzzyScore(repo, searchTerms) {
    const fullName = repo.full_name.toLowerCase();
    const description = (repo.description || '').toLowerCase();
    const language = (repo.language || '').toLowerCase();
    
    let score = 0;
    
    for (const term of searchTerms) {
        // Exact matches get highest score
        if (fullName.includes(term)) {
            score += term.length * 10;
        }
        
        // Description matches
        if (description.includes(term)) {
            score += term.length * 3;
        }
        
        // Language matches
        if (language.includes(term)) {
            score += term.length * 5;
        }
        
        // Fuzzy matching (characters in order)
        if (fuzzyMatch(fullName, term)) {
            score += term.length * 2;
        }
    }
    
    // Boost score for recently updated repos
    const daysSinceUpdate = (Date.now() - new Date(repo.updated_at)) / (1000 * 60 * 60 * 24);
    if (daysSinceUpdate < 30) score += 5;
    else if (daysSinceUpdate < 90) score += 3;
    
    return score;
}

function fuzzyMatch(text, pattern) {
    let patternIdx = 0;
    for (let i = 0; i < text.length && patternIdx < pattern.length; i++) {
        if (text[i] === pattern[patternIdx]) {
            patternIdx++;
        }
    }
    return patternIdx === pattern.length;
}

function highlightMatch(text, query) {
    const regex = new RegExp(`(${query.split(' ').join('|')})`, 'gi');
    return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
}

async function handleArbitraryRepo(input) {
    const dropdown = document.getElementById('repository-dropdown');
    
    let ownerRepo;
    
    // Extract owner/repo from various formats
    if (input.includes('github.com')) {
        const match = input.match(/github\.com[\/:]([^\/]+)\/([^\/\s]+)/);
        if (match) {
            ownerRepo = `${match[1]}/${match[2].replace(/\.git$/, '')}`;
        }
    } else if (input.match(/^[\w\-\.]+\/[\w\-\.]+$/)) {
        ownerRepo = input;
    }
    
    if (!ownerRepo) {
        dropdown.innerHTML = `
            <div class="p-3 text-red-500">
                Invalid format. Use owner/repo or GitHub URL.
            </div>
        `;
        dropdown.classList.remove('hidden');
        return;
    }
    
    dropdown.innerHTML = `
        <div class="dropdown-item p-3 hover:bg-gray-100 cursor-pointer"
             data-custom-repo='${ownerRepo}'>
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <div>
                    <div class="font-medium">${ownerRepo}</div>
                    <div class="text-sm text-gray-600">External repository - click to preview</div>
                </div>
            </div>
        </div>
    `;
    
    dropdown.querySelector('.dropdown-item').addEventListener('click', async () => {
        await fetchExternalRepo(ownerRepo);
    });
    
    dropdown.classList.remove('hidden');
}

async function fetchExternalRepo(ownerRepo) {
    const [owner, repo] = ownerRepo.split('/');
    
    try {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
        if (response.ok) {
            const repoData = await response.json();
            const customRepo = {
                id: repoData.id,
                name: repoData.name,
                full_name: repoData.full_name,
                description: repoData.description,
                html_url: repoData.html_url,
                clone_url: repoData.clone_url,
                private: repoData.private,
                language: repoData.language,
                updated_at: repoData.updated_at,
                stargazers_count: repoData.stargazers_count,
                forks_count: repoData.forks_count,
                external: true
            };
            selectRepository(customRepo);
        } else {
            alert('Repository not found or not accessible');
        }
    } catch (error) {
        console.error('Error fetching external repo:', error);
        alert('Error fetching repository information');
    }
}

function selectRepository(repo) {
    selectedRepo = repo;
    document.getElementById('repository-input').value = repo.full_name;
    document.getElementById('repository-dropdown').classList.add('hidden');
    showRepositoryPreview(repo);
}

function showRepositoryPreview(repo) {
    document.getElementById('repo-name').textContent = repo.full_name;
    document.getElementById('repo-description').textContent = repo.description || 'No description available';
    
    // Show languages and metadata
    const languagesDiv = document.getElementById('repo-languages');
    languagesDiv.innerHTML = '';
    
    const badges = [];
    if (repo.language) badges.push({text: repo.language, color: 'blue'});
    if (repo.private) badges.push({text: 'Private', color: 'gray'});
    else badges.push({text: 'Public', color: 'green'});
    if (repo.owner_type === 'Organization') badges.push({text: 'Organization', color: 'blue'});
    if (repo.fork) badges.push({text: 'Fork', color: 'yellow'});
    if (repo.external) badges.push({text: 'External', color: 'purple'});
    if (repo.stargazers_count) badges.push({text: `⭐ ${repo.stargazers_count}`, color: 'indigo'});
    if (repo.permissions) {
        if (repo.permissions.admin) badges.push({text: 'Admin', color: 'red'});
        else if (repo.permissions.push) badges.push({text: 'Write', color: 'orange'});
        else badges.push({text: 'Read', color: 'gray'});
    }
    
    badges.forEach(badge => {
        const badgeEl = document.createElement('span');
        badgeEl.className = `bg-${badge.color}-100 text-${badge.color}-800 text-xs px-2 py-1 rounded`;
        badgeEl.textContent = badge.text;
        languagesDiv.appendChild(badgeEl);
    });
    
    document.getElementById('repo-preview').classList.remove('hidden');
}

function hideRepositoryPreview() {
    selectedRepo = null;
    document.getElementById('repo-preview').classList.add('hidden');
}

function showError(message) {
    const loadingDiv = document.getElementById('loading-repos');
    loadingDiv.innerHTML = `
        <div class="text-center py-8">
            <svg class="w-12 h-12 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.232 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <p class="text-red-600 mb-4">${message}</p>
            <button onclick="location.reload()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                Try Again
            </button>
        </div>
    `;
}

// Handle form submission
document.getElementById('create-context-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!selectedRepo) {
        alert('Please select a repository');
        return;
    }
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating Context...';
    
    const formData = new FormData(e.target);
    const data = {
        name: selectedRepo.full_name,
        description: selectedRepo.description,
        github_repo_url: selectedRepo.html_url,
        is_public: formData.get('is_public') === 'on'
    };
    
    try {
        const response = await fetch('/api/contexts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const context = await response.json();
            window.location.href = `/contexts/${context.id}`;
        } else {
            const error = await response.json();
            alert(`Error: ${error.detail || 'Failed to create context'}`);
        }
    } catch (error) {
        console.error('Error creating context:', error);
        alert('Error creating context. Please try again.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Context';
    }
});
</script>
{% endblock %}